<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WiFi-DensePose Pose Dashboard</title>
  <style>
    :root {
      --bg: #0d1b2a;
      --panel: #1b263b;
      --panel-soft: #243447;
      --text: #e0e1dd;
      --muted: #a7b0bf;
      --accent: #5bc0be;
      --danger: #ff6b6b;
      --ok: #9be564;
      --grid: rgba(255, 255, 255, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      color: var(--text);
      font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 0%, #1b263b 0%, var(--bg) 55%);
      min-height: 100vh;
      padding: 20px;
    }

    .layout {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
      grid-template-columns: 1.4fr 1fr;
    }

    .panel {
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-soft) 100%);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25);
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }

    input, button {
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 8px 10px;
      color: var(--text);
      background: rgba(0, 0, 0, 0.2);
      font: inherit;
    }

    button {
      background: #355070;
      cursor: pointer;
      transition: transform 120ms ease, background 120ms ease;
    }

    button:hover { transform: translateY(-1px); background: #43658a; }

    #status {
      font-size: 13px;
      color: var(--muted);
      margin-left: auto;
    }

    canvas {
      width: 100%;
      aspect-ratio: 16 / 10;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: #0a1624;
      display: block;
    }

    h1, h2 { margin: 0 0 10px 0; }
    h1 { font-size: 20px; }
    h2 { font-size: 16px; color: var(--muted); }

    .meta { font-size: 13px; color: var(--muted); margin-bottom: 10px; }

    .person-list {
      display: grid;
      gap: 8px;
      max-height: 520px;
      overflow: auto;
    }

    .person {
      padding: 10px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 13px;
      line-height: 1.35;
    }

    .z-tag { color: var(--ok); }
    .danger-tag { color: var(--danger); }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      #status { margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <section class="panel">
      <h1>Pose Location Stream</h1>
      <div class="controls">
        <input id="baseUrl" type="text" value="http://127.0.0.1:8787" style="min-width: 240px">
        <button id="connectBtn">Connect</button>
        <button id="seedBtn">Seed Demo Step</button>
        <span id="status">disconnected</span>
      </div>
      <canvas id="floorCanvas" width="960" height="600"></canvas>
      <div class="meta" id="frameMeta">No frame yet</div>
    </section>

    <aside class="panel">
      <h2>Tracked Persons</h2>
      <div id="personList" class="person-list">
        <div class="person">No persons in frame</div>
      </div>
    </aside>
  </div>

  <script>
    const state = {
      ws: null,
      frame: null,
      baseUrl: localStorage.getItem("pose.baseUrl") || "http://127.0.0.1:8787",
    };

    const baseUrlInput = document.getElementById("baseUrl");
    const statusEl = document.getElementById("status");
    const personListEl = document.getElementById("personList");
    const frameMetaEl = document.getElementById("frameMeta");
    const canvas = document.getElementById("floorCanvas");
    const ctx = canvas.getContext("2d");

    baseUrlInput.value = state.baseUrl;

    function toWsUrl(baseUrl) {
      return baseUrl.replace(/^http/i, "ws") + "/ws/pose/stream";
    }

    function setStatus(text) {
      statusEl.textContent = text;
    }

    async function fetchCurrent() {
      const response = await fetch(`${state.baseUrl}/api/v1/pose/current`);
      if (!response.ok) throw new Error(`GET /pose/current failed: ${response.status}`);
      const frame = await response.json();
      applyFrame(frame);
    }

    function connect() {
      if (state.ws) state.ws.close();
      state.baseUrl = baseUrlInput.value.trim();
      localStorage.setItem("pose.baseUrl", state.baseUrl);

      fetchCurrent().catch((error) => setStatus(error.message));

      const ws = new WebSocket(toWsUrl(state.baseUrl));
      state.ws = ws;
      setStatus("connecting...");

      ws.onopen = () => setStatus("connected");
      ws.onclose = () => setStatus("disconnected");
      ws.onerror = () => setStatus("socket error");
      ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        if (message.type === "pose_frame") {
          applyFrame(message);
        }
      };
    }

    async function seedDemoStep() {
      const response = await fetch(`${state.baseUrl}/api/v1/pose/demo/seed`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ survivors: 3 }),
      });
      if (!response.ok) {
        const text = await response.text();
        throw new Error(text || `seed failed: ${response.status}`);
      }
      const payload = await response.json();
      applyFrame(payload.frame);
    }

    function applyFrame(frame) {
      state.frame = frame;
      renderFrame();
      renderPersons();
    }

    function renderFrame() {
      const frame = state.frame;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#08111c";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--grid");
      for (let x = 0; x <= canvas.width; x += 40) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y <= canvas.height; y += 40) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }

      if (!frame) {
        frameMetaEl.textContent = "No frame yet";
        return;
      }

      frameMetaEl.textContent = `frame ${frame.frame_id} | ${frame.coordinate_frame} | ${frame.persons.length} person(s)`;

      for (const person of frame.persons) {
        const scale = 20;
        const px = canvas.width * 0.5 + person.location_3d.x * scale;
        const py = canvas.height * 0.5 - person.location_3d.y * scale;
        const z = person.location_3d.z;

        const depthColor = z < 0 ? "#ff8c42" : "#5bc0be";
        ctx.fillStyle = depthColor;
        ctx.beginPath();
        ctx.arc(px, py, 9, 0, Math.PI * 2);
        ctx.fill();

        ctx.strokeStyle = "rgba(255,255,255,0.85)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(px, py, 14 + person.location_3d.uncertainty_radius * 6, 0, Math.PI * 2);
        ctx.stroke();

        ctx.fillStyle = "#ffffff";
        ctx.font = "12px IBM Plex Sans, sans-serif";
        ctx.fillText(`z=${z.toFixed(2)}m`, px + 12, py + 4);
      }
    }

    function renderPersons() {
      const frame = state.frame;
      if (!frame || !frame.persons.length) {
        personListEl.innerHTML = '<div class="person">No persons in frame</div>';
        return;
      }

      personListEl.innerHTML = frame.persons.map((person) => {
        const loc = person.location_3d;
        const zClass = loc.z < 0 ? "danger-tag" : "z-tag";
        return `
          <div class="person">
            <div><strong>${person.id.slice(0, 8)}...</strong></div>
            <div>x: ${loc.x.toFixed(2)}m | y: ${loc.y.toFixed(2)}m | <span class="${zClass}">z: ${loc.z.toFixed(2)}m</span></div>
            <div>confidence: ${person.confidence.toFixed(2)} | uncertainty: ${loc.uncertainty_radius.toFixed(2)}m</div>
          </div>
        `;
      }).join("");
    }

    document.getElementById("connectBtn").addEventListener("click", connect);
    document.getElementById("seedBtn").addEventListener("click", () => {
      seedDemoStep().catch((error) => setStatus(error.message));
    });

    connect();
  </script>
</body>
</html>
